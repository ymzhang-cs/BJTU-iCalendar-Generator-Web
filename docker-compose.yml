version: '3.8'

services:
  # Web应用服务
  web:
    build: .
    ports:
      - "5000:5000"
    volumes:
      - ./uploads:/app/uploads
      - ./outputs:/app/outputs
    environment:
      - FLASK_ENV=production
      - SECRET_KEY=your-secret-key-change-in-production
    depends_on:
      - radicale
    restart: unless-stopped

  # Radicale CalDAV服务
  radicale:
    image: tomsquest/docker-radicale:latest
    ports:
      - "5232:5232"
    volumes:
      - radicale_data:/data
      - ./radicale_config:/config
    environment:
      - RADICALE_SERVER_HOSTS=0.0.0.0:5232
      - RADICALE_AUTH_TYPE=htpasswd
      - RADICALE_AUTH_HTPASSWD_FILENAME=/config/users
      - RADICALE_AUTH_HTPASSWD_ENCRYPTION=bcrypt
      - RADICALE_RIGHTS_TYPE=owner_only
      - RADICALE_STORAGE_TYPE=filesystem
      - RADICALE_STORAGE_FILESYSTEM_FOLDER=/data
    restart: unless-stopped

  # Nginx反向代理（可选）
  nginx:
    image: nginx:alpine
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./nginx.conf:/etc/nginx/nginx.conf
      - ./ssl:/etc/nginx/ssl
    depends_on:
      - web
      - radicale
    restart: unless-stopped

volumes:
  radicale_data:
